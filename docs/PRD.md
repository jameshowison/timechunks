# timechunks — Product Requirements Document

**Version:** 1.0  
**Date:** 2026-02-17  
**Status:** Ready for implementation  
**Target:** Claude Code implementation agent

---

## 1. Purpose

`timechunks` is a generalized R package for handling named, domain-specific time periods that don't align with calendar years — academic semesters, fiscal quarters, historical epochs, and any custom named period system.

Existing packages (`lubridate`, `zoo`, `tsibble`) handle standard calendar periods. None handle *configurable named periods* with cross-year boundaries, multiple naming conventions, and chronological sorting.

---

## 2. Core Problem

Academic and institutional data uses period names that:

- Cross calendar year boundaries (`Fall 2026` → `Spring 2027` = Academic Year 2026-27)
- Have multiple representations (`fa26`, `Fall 2026`, `20268`, `2026-27_1_08_Fall`)
- Need chronological sorting despite non-alphabetic naming
- Must survive `dplyr`/`tidyr` transformations intact
- Need to integrate with `ggplot2` without special scale infrastructure

---

## 3. Non-Goals

- **Not** a replacement for `lubridate` date arithmetic
- **Not** a custom `ggplot2` scale (rejected — see Design Decisions)
- **Not** a database of institutional calendars (presets only, user-configurable)
- **Not** a Python package (R only)

---

## 4. Architecture

### 4.1 Class Design

Use **vctrs record class** (`vctrs::new_rcrd`). This is non-negotiable.

**Why vctrs:**
- Preserves full record structure through all `dplyr`/`tidyr` operations
- Sorting handled automatically via `vec_proxy_compare()` → returns `start_date`
- Works with `ggplot2` without custom scale methods
- Type-safe, composable with tidyverse

```r
new_time_chunk <- function(
  start_date,   # Date — period start
  end_date,     # Date — period end  
  name,         # character — "Fall"
  code,         # character — "fa"
  year,         # integer — 2026
  period_index, # integer — position within year (1, 2, 3...)
  ay            # character — "2026-27" (or fiscal year equiv)
) {
  vctrs::new_rcrd(
    list(
      start_date   = start_date,
      end_date     = end_date,
      name         = name,
      code         = code,
      year         = year,
      period_index = period_index,
      ay           = ay
    ),
    class = "time_chunk"
  )
}
```

### 4.2 Calendar Configuration System

The calendar config drives all parsing and formatting. The package is **not** semester-specific.

```r
# Full configuration
set_chunk_calendar(
  periods = list(
    list(name = "Fall",   code = "fa", start_mmdd = "08-23"),
    list(name = "Spring", code = "sp", start_mmdd = "01-15"),
    list(name = "Summer", code = "su", start_mmdd = "06-01")
  ),
  year_start_period = "Fall",   # Which period begins the academic/fiscal year
  yyyym_strict = TRUE,          # Error on ambiguous month mappings (see §6.3)
  name = "my_calendar"          # Optional: for multi-calendar datasets
)

# Preset shortcut
use_chunk_preset("us_semester")

# View current calendar
default_chunk_calendar()
```

**End date resolution** (in priority order):
1. Explicit `end_mmdd` in period config, OR
2. Day before next period's `start_mmdd`, OR
3. Last day of the year for the final period

This means end dates are **always computed**, never stored in config unless the user explicitly overrides. Implement option 2/3 as the default.

### 4.3 Package Structure

Follow standard R package conventions. Use `usethis` and `devtools` for scaffolding.

```
timechunks/
├── DESCRIPTION
├── NAMESPACE
├── R/
│   ├── class.R          # new_time_chunk(), validator, type checks
│   ├── calendar.R       # set_chunk_calendar(), use_chunk_preset(), default_chunk_calendar()
│   ├── parse.R          # time_chunk(), period_code(), period_numeric(), period_text()
│   ├── format.R         # format.time_chunk(), print.time_chunk()
│   ├── accessors.R      # start_date(), end_date(), mid_date(), chunk_name(), etc.
│   ├── arithmetic.R     # +, -, seq methods
│   ├── vctrs-methods.R  # vec_proxy_compare(), vec_ptype_abbr(), etc.
│   ├── ggplot-helpers.R # as_chunk_factor(), date helpers for plotting
│   ├── presets.R        # Built-in calendar presets
│   └── utils.R          # Internal helpers
├── tests/
│   └── testthat/
│       ├── test-class.R
│       ├── test-calendar.R
│       ├── test-parse.R
│       ├── test-format.R
│       ├── test-accessors.R
│       ├── test-arithmetic.R
│       └── test-ggplot-helpers.R
├── vignettes/
│   ├── getting-started.Rmd
│   └── ggplot2-visualization.Rmd
└── man/          # Generated by roxygen2
```

---

## 5. API Specification

### 5.1 Construction / Parsing

The main entry point. Dispatches to sub-parsers based on input type.

```r
# Primary constructor — dispatches automatically
time_chunk(x, calendar = default_chunk_calendar())

# Examples
time_chunk("fa26")              # code format
time_chunk("Fall 2026")         # text format
time_chunk(20268)               # YYYYM numeric format
time_chunk("2026-27_1_08_Fall") # composite key format

# Sub-parsers (also exported, useful for explicit control)
parse_chunk_code(x, calendar)    # "fa26" → time_chunk
parse_chunk_numeric(x, calendar) # 20268 → time_chunk
parse_chunk_text(x, calendar)    # "Fall 2026" → time_chunk

# Vectorized — returns vctrs record of length n
time_chunk(c("fa26", "sp27", "su27"))
```

### 5.2 Accessors

All return atomic vectors of the same length as input.

```r
chunk_name(x)        # character: "Fall"
chunk_code(x)        # character: "fa"
chunk_year(x)        # integer:   2026
chunk_ay(x)          # character: "2026-27"
chunk_index(x)       # integer:   1 (position in year)
start_date(x)        # Date:      2026-08-23
end_date(x)          # Date:      2027-01-14
mid_date(x)          # Date:      midpoint between start and end
```

### 5.3 Formatting

```r
format(x, style = "code")      # "fa26"
format(x, style = "name")      # "Fall 2026"
format(x, style = "ay")        # "2026-27"
format(x, style = "key")       # "2026-27_1_08_Fall" (sortable composite)
format(x, style = "iso_date")  # "2026-08-23"

# Custom template (glue-style)
format(x, style = "{ay}_{chunk_index}_{name}")
# "2026-27_1_Fall"
```

`print.time_chunk()` should show something like:
```
<time_chunk[3]>
[1] Fall 2026  Spring 2027  Summer 2027
Calendar: us_semester
```

### 5.4 Arithmetic

```r
# Move forward/backward N periods
time_chunk("fa26") + 1L      # Spring 2027
time_chunk("fa26") + 2L      # Summer 2027
time_chunk("sp27") - 1L      # Fall 2026

# Distance between periods (integer)
time_chunk("sp27") - time_chunk("fa26")   # 1L

# Sequence
seq(time_chunk("fa26"), time_chunk("fa27"), by = 1L)
# Fall 2026, Spring 2027, Summer 2027, Fall 2027
```

### 5.5 ggplot2 Helpers

Do **not** build a custom `scale_x_*`. Use helper functions that create the label columns users pass to ggplot2 explicitly. This follows standard tidyverse patterns.

```r
# Convert to ordered factor for discrete scales
as_chunk_factor(x, labels = "code")   # ordered factor: fa26 < sp27 < su27
as_chunk_factor(x, labels = "name")   # ordered factor: Fall 2026 < Spring 2027 < Summer 2027

# Convenience: extract dates for continuous scales
# (same as start_date/end_date/mid_date accessors — just document these use cases)
```

**Document this pattern prominently in the vignette:**

```r
# Discrete scale (equal spacing)
df |>
  mutate(semester_fct = as_chunk_factor(semester, labels = "code")) |>
  ggplot(aes(x = semester_fct, y = enrollment)) +
  geom_col()

# Continuous scale (proportional spacing)
df |>
  mutate(
    mid  = mid_date(semester),
    lbl  = format(semester, "code")
  ) |>
  ggplot(aes(x = mid, y = enrollment)) +
  geom_point() +
  scale_x_date(breaks = ~.$mid, labels = ~.$lbl)

# Recommended: segment visualization (shows duration)
df |>
  mutate(
    x_start = start_date(semester),
    x_end   = end_date(semester),
    x_mid   = mid_date(semester),
    lbl     = format(semester, "code")
  ) |>
  ggplot() +
  geom_segment(aes(x = x_start, xend = x_end,
                   y = enrollment, yend = enrollment,
                   color = lbl), linewidth = 4) +
  geom_point(aes(x = x_mid, y = enrollment)) +
  scale_x_date()
```

### 5.6 Aggregation

```r
# Group by academic year
df |> group_by(ay = chunk_ay(semester)) |> summarise(total = sum(n))

# Rollup helper
rollup_to_ay(df, value_col = "enrollment", chunk_col = "semester")
```

---

## 6. Parsing Details

### 6.1 Code Format (`fa26`)

Pattern: `{code}{2-digit-year}` where code matches a configured period code.

- Match codes case-insensitively
- 2-digit year: 00–49 → 2000–2049, 50–99 → 1950–1999 (standard R convention)
- Error clearly if code not found in current calendar

### 6.2 Text Format (`Fall 2026`, `2026 Fall`)

Pattern: `{name} {4-digit-year}` or `{4-digit-year} {name}`

- Match names case-insensitively
- Trim whitespace
- Error clearly if name not found in calendar

### 6.3 YYYYM Numeric Format

**Variable-length numeric:**
- 5 digits: months 1–9 (e.g., `20268` = August 2026)
- 6 digits: months 10–12 (e.g., `202611` = November 2026)

**Ambiguity:** A month may fall in multiple configured periods (e.g., if Fall starts Aug 23, then August is a Fall month but July might also be late Summer). Resolution:

- If `yyyym_strict = TRUE`: Error on any ambiguous month mapping. User must provide explicit month→period mapping in config.
- If `yyyym_strict = FALSE`: Use the period whose `start_mmdd` is closest to (but not after) the given month.

Provide `yyyym_map` argument to `set_chunk_calendar()` for explicit overrides:

```r
set_chunk_calendar(
  periods = ...,
  yyyym_map = list("08" = "Fall", "09" = "Fall", "01" = "Spring")
)
```

### 6.4 Composite Key Format

Pattern: `{ay}_{index}_{mm}_{name}` e.g. `2026-27_1_08_Fall`

Parse by splitting on `_` and validating each component. This format is primarily for round-tripping from `format(x, style = "key")`.

---

## 7. Calendar Presets

Implement all as named configurations in `presets.R`. Activated via `use_chunk_preset()`.

| Preset name | Periods | Year start |
|---|---|---|
| `"us_semester"` | Fall (Aug 23), Spring (Jan 15), Summer (Jun 1) | Fall |
| `"us_quarter"` | Fall (Sep 20), Winter (Jan 5), Spring (Mar 30), Summer (Jun 20) | Fall |
| `"uk_terms"` | Michaelmas (Oct 1), Lent (Jan 15), Easter (Apr 22) | Michaelmas |
| `"trimester"` | Fall (Sep 1), Winter (Jan 10), Spring (Apr 1) | Fall |
| `"us_federal_fy"` | Q1 (Oct 1), Q2 (Jan 1), Q3 (Apr 1), Q4 (Jul 1) | Q1 |
| `"australia_semester"` | Semester 1 (Feb 22), Semester 2 (Jul 22) | Semester 1 |

For `"australia_semester"`, `ay` should be a single year string (e.g. `"2026"`) since the year doesn't span a boundary.

---

## 8. vctrs Methods Required

Implement all of the following. These are required for correct tidyverse integration.

```r
vec_proxy_compare.time_chunk()   # return start_date for sorting
vec_ptype_abbr.time_chunk()      # return "tchk"
vec_ptype_full.time_chunk()      # return "time_chunk"
vec_cast.time_chunk()            # cast to/from character, Date
vec_ptype2.time_chunk()          # type compatibility
```

---

## 9. Design Decisions (Do Not Revisit Without Strong Reason)

| Decision | Rationale |
|---|---|
| vctrs record class | Survives dplyr/tidyr, enables sorting, type-safe |
| No custom ggplot2 scales | Standard label-column pattern is simpler and more explicit |
| Variable-length YYYYM (5/6 digits) | Self-describing, no special syntax, works with `as.integer()` |
| Generalized calendar config, not semester-only | Fiscal, historical, multi-institution use cases are equivalent |
| End dates computed from next period start | Less config burden, correct by default |
| Separate `time_chunk()` constructor from `new_time_chunk()` | Public API vs. internal constructor (standard R pattern) |

---

## 10. Implementation Phases

### Phase 1 — Core (Start Here)

- [ ] Package scaffold via `usethis::create_package("timechunks")`
- [ ] `new_time_chunk()` internal constructor + validator
- [ ] `time_chunk()` public constructor with dispatch
- [ ] All vctrs methods
- [ ] Calendar config system + `us_semester` preset only
- [ ] Parse: code format (`fa26`)
- [ ] Parse: text format (`Fall 2026`)
- [ ] Parse: YYYYM numeric
- [ ] `format.time_chunk()` — all styles
- [ ] `print.time_chunk()`
- [ ] All accessor functions
- [ ] `testthat` tests for all of the above (aim for >90% coverage)

### Phase 2 — Arithmetic + ggplot2

- [ ] `+` and `-` operators
- [ ] `seq.time_chunk()`
- [ ] `as_chunk_factor()`
- [ ] ggplot2 integration vignette

### Phase 3 — Remaining Presets

- [ ] `us_quarter`, `uk_terms`, `trimester`, `us_federal_fy`, `australia_semester`
- [ ] YYYYM strict mode + explicit month mapping

### Phase 4 — Polish

- [ ] `rollup_to_ay()` aggregation helper
- [ ] Comprehensive `roxygen2` documentation
- [ ] `getting-started` vignette
- [ ] `pkgdown` site config
- [ ] CRAN check (`R CMD check --as-cran`)

---

## 11. Dependencies

**Required:**
- `vctrs` — record class, proxy methods

**Suggested (use if already in tidyverse imports, avoid otherwise):**
- `rlang` — error/warning helpers (`abort()`, `warn()`)

**Forbidden (do not add):**
- `lubridate` — unnecessary for this package's needs
- `tidyverse` — never import the meta-package

**Dev-only (not in DESCRIPTION Imports):**
- `testthat` (>= 3.0.0)
- `devtools`
- `usethis`
- `roxygen2`
- `ggplot2` (for vignettes only — move to Suggests)

---

## 12. Error Messages

Errors should be specific and actionable. Use `rlang::abort()` with `class` for programmatic handling.

```r
# Good
abort(
  "Period code 'wi' not found in current calendar. Available codes: fa, sp, su",
  class = "timechunks_unknown_code"
)

# Bad
stop("Invalid input")
```

---

## 13. Testing Requirements

- Use `testthat` >= 3.0 with `test_that()` and `expect_*` functions
- Every exported function needs tests
- Test edge cases: year boundaries, Southern Hemisphere, YYYYM ambiguity
- Snapshot tests for `print.time_chunk()` output
- Test that vctrs methods work correctly through `dplyr::mutate()` and `tidyr::pivot_longer()`

---

## 14. Success Criteria

- [ ] `time_chunk(c("fa26", "sp27")) |> sort()` returns chronologically sorted result
- [ ] `dplyr::mutate(df, s = time_chunk(semester_col))` works without data loss
- [ ] `format(time_chunk("fa26"), style = "key")` produces `"2026-27_1_08_Fall"`
- [ ] `time_chunk("fa26") + 1L` returns `Spring 2027`
- [ ] `R CMD check --as-cran` produces 0 errors, 0 warnings
- [ ] >90% test coverage via `covr`
